name: Pulumi

on:
  push:
    branches: [ main, release/* ]
    paths:
      - 'infra/pulumi/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'infra/pulumi/**'
  workflow_dispatch:

jobs:
  check:
    name: Check Node.js
    uses: ./.github/workflows/node-check.yaml

  preview:
    strategy:
      matrix:
        profile: [ 'dev', 'qa', 'prod' ]
    name: Pulumi Preview
    if: github.ref != 'refs/heads/main'
    needs: check
    uses: ./.github/workflows/pulumi-preview.yaml
    with:
      profile: ${{ matrix.profile }}
    secrets: inherit

  up-non-prod:
    strategy:
      matrix:
        profile: [ 'dev', 'qa', 'prod' ]
    name: Pulumi Up
    if: github.ref == 'refs/heads/main'
    needs: check
    uses: ./.github/workflows/pulumi-up.yaml
    with:
      profile: ${{ matrix.profile }}
    secrets: inherit

  up-prod:
    strategy:
      matrix:
        profile: [ 'prod' ]
    name: Pulumi Up
    if: github.ref == 'refs/heads/release/*'
    needs: check
    uses: ./.github/workflows/pulumi-up.yaml
    with:
      profile: ${{ matrix.profile }}
    secrets: inherit
